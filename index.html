<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Styling Activity Demo - Mobile Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --primary: #FF4D4F;
            --secondary: #FF8500;
            --bg: #F5F5F7;
        }

        /* æ¡Œé¢ç«¯å±…ä¸­å®¹å™¨ */
        body {
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* å†…å®¹å®¹å™¨ï¼ˆæ— æ‰‹æœºå¤–å£³ï¼‰ */
        .phone-container {
            width: 375px;
            height: 812px;
            background: var(--bg);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨åˆ˜æµ·å·²ç§»é™¤ */
        .phone-notch {
            display: none;
        }

        /* çŠ¶æ€æ æ¨¡æ‹Ÿ */
        .status-bar {
            height: 44px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            z-index: 999;
            background: transparent;
        }

        /* æ»šåŠ¨åŒºåŸŸæ§åˆ¶ */
        .screen-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .screen-content::-webkit-scrollbar { display: none; }

        /* é¡µé¢åŸºç¡€æ ·å¼ */
        .page { display: none; min-height: 100%; width: 100%; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }

        /* å¯¼èˆªæ å’Œå¼¹çª—ç›¸å¯¹äºæ‰‹æœºå®šä½ */
        .tab-bar {
            position: absolute; /* æ”¹ä¸ºç›¸å¯¹äºæ‰‹æœºå®¹å™¨ */
            bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            display: flex;
            padding: 10px 0 24px 0;
            border-top: 0.5px solid #ddd;
            z-index: 50;
        }

        .modal {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 100;
            display: none;
            justify-content: flex-end;
            flex-direction: column;
        }

        .btn-gradient { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 25px; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

        /* æ¨¡ç‰¹/å§¿åŠ¿æ¨ªå‘æ»šåŠ¨å®¹å™¨ */
        .scroll-row-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            gap: 12px;
            padding: 8px 0;
            -webkit-overflow-scrolling: touch;
        }
        .scroll-row-container::-webkit-scrollbar { display: none; }
        .scroll-row-item {
            flex-shrink: 0;
            width: 72px;
            height: 96px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .scroll-row-item.selected { border-color: var(--primary); }
        .scroll-row-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* Tryon å…¨å±é®ç½© */
        #modal-tryon {
            position: absolute;
            inset: 0;
            z-index: 150;
            background: #000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #modal-tryon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>

    <!-- æ‰‹æœºå¤–å£³å¼€å§‹ -->
    <div class="phone-container">
        <div class="phone-notch"></div>
        
        <!-- æ¨¡æ‹ŸçŠ¶æ€æ  -->
        <div class="status-bar">
            <span>9:41</span>
            <button onclick="showTryonEntry()" class="text-[9px] font-medium text-blue-600 px-1 py-0.5 rounded bg-blue-50">simulate tryon entry</button>
            <div class="flex space-x-1">
                <span>ğŸ“¶</span><span>ğŸ”‹</span>
            </div>
        </div>

        <!-- Tryon å…¨å±å±•ç¤º -->
        <div id="modal-tryon" onclick="closeTryonEntry()">
            <img src="source/tryonentry.png" alt="Tryon Entry">
        </div>

        <!-- å±å¹•å†…å®¹åŒºåŸŸ -->
        <div class="screen-content">
            
            <!-- 1. æ´»åŠ¨è½åœ°é¡µ -->
            <section id="page-landing" class="page active">
                <div class="h-40 bg-gray-200 relative overflow-hidden">
                    <img src="source/é¦–é¡µèƒŒæ™¯.jpg" class="w-full h-full object-cover object-[center_38%]">
                </div>
                <div class="p-4 pt-3 pb-20">
                    <div class="mb-3 p-3 bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl text-xs text-orange-700 font-medium leading-relaxed">
                        ğŸ¯ Join the styling challenge and earn up to 50% off voucher reward for high scores!
                    </div>
                    <div class="flex justify-between items-end mb-4">
                        <h2 class="font-bold text-gray-800">Popular Challenge Themes</h2>
                        <span class="text-xs text-red-500 italic">24k Joined</span>
                    </div>
                    <div id="theme-list" class="grid grid-cols-2 gap-3">
                        <!-- JS æ¸²æŸ“ä¸»é¢˜å¡ç‰‡ -->
                    </div>
                </div>
            </section>

            <!-- 2. æ­é…ç¼–è¾‘å™¨é¡µ -->
            <section id="page-editor" class="page">
                <div class="p-4 flex items-center bg-white sticky top-0 z-10 shadow-sm">
                    <button onclick="navigateTo('page-landing')" class="text-xl">â€¹</button>
                    <h2 id="current-theme-title" class="flex-1 text-center font-bold text-sm">Customize Outfit</h2>
                    <div class="w-6"></div>
                </div>
                <div class="flex flex-col flex-1 p-4">
                    <!-- Upload your image åŒºåŸŸ -->
                    <div id="upload-area" class="h-80 flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-2xl bg-white mb-4 cursor-pointer" onclick="showUploadedImage()">
                        <input type="file" id="file-upload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                        <img id="uploaded-preview" src="" class="hidden w-full h-full object-contain rounded-2xl">
                        <div id="upload-placeholder" class="flex flex-col items-center">
                            <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center mb-3">
                                <span class="text-2xl text-gray-400">+</span>
                            </div>
                            <div class="text-sm font-bold text-gray-600">Upload Your Image</div>
                            <div class="text-[10px] text-gray-400 mt-1">Tap to select a photo</div>
                        </div>
                    </div>
                    <!-- æœè£…é€‰é¡¹æ¨ªæ’ -->
                    <div id="category-list" class="grid grid-cols-3 gap-3 mb-4">
                        <!-- æ¸²æŸ“ç±»åˆ«å¡ç‰‡ -->
                    </div>
                    <button id="btn-submit" class="w-full btn-gradient py-4 font-bold opacity-50 pointer-events-none shadow-lg">
                        Generate AI Report
                    </button>
                </div>
            </section>

            <!-- 4. ç»“æœé¡µ -->
            <section id="page-result" class="page bg-white">
                <div class="flex flex-col">
                    <div class="p-3 flex justify-center items-center" style="background-color: #D1D5D7;">
                        <img id="ootd-combined-img" src="source/å®Œæ•´ç…§ç‰‡1.jpg" alt="Outfit Result" class="w-[65%] max-w-[320px] aspect-[3/4] object-cover object-top rounded-lg">
                    </div>
                    <div class="p-4">
                        <div class="flex gap-4 items-stretch mb-6 p-4 bg-gray-50 rounded-2xl">
                        <div class="flex-shrink-0 flex flex-col items-center justify-center pr-4 border-r border-gray-200">
                            <div id="ai-score" class="text-5xl font-black text-orange-500">0</div>
                            <div class="text-xs font-bold text-gray-600 mt-1">Score</div>
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center">
                            <div class="text-xs font-bold text-gray-500 mb-1">AI Comment</div>
                            <p id="ai-comment" class="text-sm text-gray-700 leading-relaxed">â€œ...â€</p>
                        </div>
                    </div>
                    <div class="flex gap-3 mb-6">
                        <button onclick="saveOotdToLocal()" class="flex-1 min-h-[44px] py-2.5 px-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-xs font-bold text-gray-800 flex items-center justify-center">Save to my album</button>
                        <button onclick="shareToSquare()" class="flex-1 min-h-[44px] py-2.5 px-2 btn-gradient text-xs font-bold flex items-center justify-center">Share to Square</button>
                    </div>
                    <!-- å¥–åŠ±æ¨¡å—ï¼šä¼˜æƒ åˆ¸ + 3 ä¸ªé™æ—¶æŠ˜æ‰£å•†å“ -->
                    <div class="my-6 p-4 bg-amber-50 rounded-2xl text-left border border-amber-100">
                        <h3 class="text-sm font-bold text-amber-800 mb-2 text-center">You win exclusive offer</h3>
                        <p class="text-xs font-bold text-gray-700 mb-3">You got 10% off voucher based on your high performance! Get them now!</p>
                        <div class="flex gap-2 items-stretch">
                            <div class="w-20 h-20 rounded-lg bg-orange-500 flex-shrink-0 flex flex-col items-center justify-center text-white font-black">
                                <span class="text-2xl leading-tight">10%</span>
                                <span class="text-sm leading-tight">Off</span>
                            </div>
                            <div id="reward-products" class="flex gap-2 flex-1 min-w-0">
                                <!-- JS å¡«å…… 3 ä¸ªå•†å“ -->
                            </div>
                        </div>
                    </div>

                    <button onclick="navigateTo('page-landing')" class="w-full py-2 text-gray-400 text-xs text-center">Back to Home</button>
                </div>
            </section>

            <!-- 5. å¹¿åœº -->
            <section id="page-square" class="page">
                <div class="bg-white p-4 sticky top-0 z-10 border-b">
                    <div class="flex justify-around text-sm">
                        <button class="font-bold text-red-500 border-b-2 border-red-500 pb-2">Inspiration Square</button>
                        <button onclick="navigateTo('page-leaderboard')" class="text-gray-400">Top Creators</button>
                    </div>
                </div>
                <div id="square-feed" class="p-3 grid grid-cols-2 gap-3"></div>
            </section>

            <!-- 6. æ’è¡Œæ¦œ -->
            <section id="page-leaderboard" class="page bg-gray-50">
                <div class="p-4 flex items-center bg-white border-b sticky top-0 z-10">
                    <button onclick="navigateTo('page-square')" class="mr-2">â€¹</button>
                    <h2 class="font-bold text-sm">Most Popular Outfits This Week</h2>
                </div>
                <div id="rank-list" class="p-3 space-y-2"></div>
            </section>

            <!-- 7. å•†å“æ¨èåˆ—è¡¨é¡µ -->
            <section id="page-recommend" class="page bg-gray-50">
                <div class="p-4 flex items-center bg-white border-b sticky top-0 z-10">
                    <button onclick="navigateTo('page-editor')" class="mr-2">â€¹</button>
                    <h2 id="recommend-title" class="font-bold text-sm flex-1">Product Recommendations</h2>
                </div>
                <div id="recommend-grid" class="p-4 grid grid-cols-2 gap-4"></div>
            </section>

        </div> <!-- Screen Content End -->

        <!-- åº•éƒ¨å¯¼èˆªï¼ˆæœè£…é€‰æ‹©é¡µä¸å±•ç¤ºï¼‰ -->
        <nav id="tab-bar" class="tab-bar">
            <div class="flex-1 text-center" onclick="navigateTo('page-landing')">
                <span class="block text-xl">ğŸ </span>
                <span class="text-[10px] text-gray-500">Activity</span>
            </div>
            <div class="flex-1 text-center" onclick="navigateTo('page-square')">
                <span class="block text-xl">ğŸ¨</span>
                <span class="text-[10px] text-gray-500">Square</span>
            </div>
        </nav>

        <!-- å•†å“é€‰æ‹©å¼¹çª— (å®šä½åœ¨ phone-container å†…) -->
        <div id="modal-picker" class="modal">
            <div class="bg-white rounded-t-3xl p-5 animate__animated animate__slideInUp">
                <div class="flex justify-between items-center mb-2">
                    <h3 id="picker-title" class="font-bold">Select Item</h3>
                    <button onclick="closePicker()" class="text-gray-300 text-2xl">&times;</button>
                </div>
                <div id="picker-subtitle" class="text-xs text-gray-500 mb-4">Select any item</div>
                <div id="product-grid" class="grid grid-cols-2 gap-3 max-h-[350px] overflow-y-auto pb-4"></div>
                <button id="btn-shop-more" onclick="goToRecommend()" class="w-full btn-gradient py-3 mt-4 font-bold shadow-lg">
                    Shop More
                </button>
            </div>
        </div>

        <!-- çµæ„Ÿå¹¿åœºå•†å“æŠ½å±‰ï¼šä¸€è¡Œä¸€ä¸ªå•†å“ï¼ˆå›¾ç‰‡ã€åç§°ã€ä»·æ ¼ã€è´­ä¹°ï¼‰ -->
        <div id="modal-square-drawer" class="modal">
            <div class="bg-white rounded-t-3xl p-5 animate__animated animate__slideInUp max-h-[85vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold">Outfit Details</h3>
                    <button onclick="closeSquareDrawer()" class="text-gray-300 text-2xl">&times;</button>
                </div>
                <div id="square-drawer-list" class="overflow-y-auto pb-4 space-y-3 flex-1">
                    <!-- JS å¡«å……ï¼šæ¯è¡Œä¸€ä¸ªå•†å“ -->
                </div>
            </div>
        </div>

    </div> <!-- Phone Container End -->

    <script>
        // --- æ•°æ®é…ç½® ---
        const THEMES = [
            { id: 1, title: 'Minimalism', img: 'source/æç®€é£.png', categories: ['Outerwear', 'Innerwear', 'Pants'] },
            { id: 2, title: 'Old Money', img: 'source/è€é’±é£.png', categories: ['Outerwear', 'Innerwear', 'Pants'] },
            { id: 3, title: 'Office Chic', img: 'source/èŒåœºé€šå‹¤.png', categories: ['Outerwear', 'Innerwear', 'Pants'] },
            { id: 4, title: 'Outdoor', img: 'source/æˆ·å¤–æ´»åŠ¨.png', categories: ['Outerwear', 'Innerwear', 'Pants'] }
        ];

        const PRODUCTS = {
            'Outerwear': [
                { name: 'Oversized Suit', price: 899, img: 'source/ä¸Šè¡£1.jpg' },
                { name: 'Trench Coat', price: 1299, img: 'source/ä¸Šè¡£2.jpg' },
                { name: 'Wool Coat', price: 1599, img: 'source/ä¸Šè¡£3.jpg' },
                { name: 'Denim Jacket', price: 599, img: 'source/ä¸Šè¡£4.jpg' },
                { name: 'Knit Cardigan', price: 449, img: 'source/ä¸Šè¡£5.jpg' },
                { name: 'Leather Jacket', price: 1899, img: 'source/ä¸Šè¡£6.jpg' },
                { name: 'Down Jacket', price: 1299, img: 'source/ä¸Šè¡£1.jpg' },
                { name: 'Workwear Jacket', price: 699, img: 'source/ä¸Šè¡£2.jpg' }
            ],
            'Innerwear': [
                { name: 'Cotton White T-Shirt', price: 199, img: 'source/ä¸Šè¡£1.jpg' },
                { name: 'Cashmere Sweater', price: 499, img: 'source/ä¸Šè¡£2.jpg' },
                { name: 'Striped Shirt', price: 299, img: 'source/ä¸Šè¡£3.jpg' },
                { name: 'Turtleneck Sweater', price: 399, img: 'source/ä¸Šè¡£4.jpg' },
                { name: 'Polo Shirt', price: 249, img: 'source/ä¸Šè¡£5.jpg' },
                { name: 'Knit Vest', price: 179, img: 'source/é…é¥°1.jpg' },
                { name: 'Long Sleeve T-Shirt', price: 159, img: 'source/ä¸Šè¡£6.jpg' },
                { name: 'Hoodie', price: 329, img: 'source/ä¸Šè¡£1.jpg' }
            ],
            'Pants': [
                { name: 'Straight Leg Jeans', price: 399, img: 'source/ä¸‹è¡£1.jpg' },
                { name: 'Draped Wide Leg Pants', price: 350, img: 'source/ä¸‹è¡£2.jpg' },
                { name: 'Casual Dress Pants', price: 499, img: 'source/ä¸‹è¡£3.jpg' },
                { name: 'Sport Pants', price: 299, img: 'source/ä¸‹è¡£4.jpg' },
                { name: 'Cargo Pants', price: 449, img: 'source/ä¸‹è¡£5.jpg' },
                { name: 'Cropped Pants', price: 379, img: 'source/ä¸‹è¡£6.jpg' },
                { name: 'Tapered Pants', price: 329, img: 'source/ä¸‹è¡£7.jpg' },
                { name: 'Khaki Pants', price: 429, img: 'source/ä¸‹è¡£1.jpg' }
            ]
        };

        // ç”¨æˆ·è®¢å•å†å²æ•°æ®ï¼ˆè¿‡å»30å¤©ï¼‰
        const USER_ORDERS = [
            { product: { name: 'Oversized Suit', price: 899, img: 'source/ä¸Šè¡£1.jpg', category: 'Outerwear' }, orderDate: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000) }, // 5å¤©å‰
            { product: { name: 'Cotton White T-Shirt', price: 199, img: 'source/ä¸Šè¡£1.jpg', category: 'Innerwear' }, orderDate: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000) }, // 8å¤©å‰
            { product: { name: 'Straight Leg Jeans', price: 399, img: 'source/ä¸‹è¡£1.jpg', category: 'Pants' }, orderDate: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000) }, // 12å¤©å‰
            { product: { name: 'Cashmere Sweater', price: 499, img: 'source/ä¸Šè¡£2.jpg', category: 'Innerwear' }, orderDate: new Date(Date.now() - 15 * 24 * 60 * 60 * 1000) }, // 15å¤©å‰
            { product: { name: 'Trench Coat', price: 1299, img: 'source/ä¸Šè¡£2.jpg', category: 'Outerwear' }, orderDate: new Date(Date.now() - 20 * 24 * 60 * 60 * 1000) }, // 20å¤©å‰
            { product: { name: 'Draped Wide Leg Pants', price: 350, img: 'source/ä¸‹è¡£2.jpg', category: 'Pants' }, orderDate: new Date(Date.now() - 25 * 24 * 60 * 60 * 1000) } // 25å¤©å‰
        ];

        // è·å–ç”¨æˆ·æŒ‡å®šç±»åˆ«å’Œæ—¶é—´èŒƒå›´å†…çš„è®¢å•å•†å“
        function getUserOrdersByCategory(category, days = 30) {
            const now = new Date();
            const daysAgo = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
            
            return USER_ORDERS
                .filter(order => {
                    return order.product.category === category && order.orderDate >= daysAgo;
                })
                .map(order => order.product);
        }

        const MOCK_SQUARE = [
            { user: 'Kira', score: 95, likes: 421, img: 'source/å®Œæ•´ç…§ç‰‡1.jpg' },
            { user: 'Xiaobei', score: 88, likes: 312, img: 'source/å®Œæ•´ç…§ç‰‡2.jpg' },
            { user: 'Luna', score: 92, likes: 286, img: 'source/å®Œæ•´ç…§ç‰‡3.jpg' },
            { user: 'Mia', score: 85, likes: 198, img: 'source/å®Œæ•´ç…§ç‰‡4.jpg' },
            { user: 'Nora', score: 90, likes: 245, img: 'source/å®Œæ•´ç…§ç‰‡1.jpg' },
            { user: 'Zoe', score: 87, likes: 176, img: 'source/å®Œæ•´ç…§ç‰‡2.jpg' }
        ];

        // å®Œæ•´ç…§ç‰‡/ç»„åˆå›¾ â†’ å•†å“ï¼šç´¢å¼• 0-based å¯¹åº”ä¸Šè¡£+ä¸‹è¡£
        function getComboProducts(comboImgPath) {
            const match = (comboImgPath || '').match(/(?:å®Œæ•´ç…§ç‰‡|ç»„åˆ)(\d+)/);
            const index = match ? parseInt(match[1], 10) - 1 : 0;
            const i = Math.max(0, Math.min(index, 7));
            return [
                { ...PRODUCTS['Outerwear'][i], category: 'Outerwear' },
                { ...PRODUCTS['Pants'][i], category: 'Pants' }
            ];
        }

        // ç»“æœé¡µå¥–åŠ±æ¨¡å—ï¼šä¼˜æƒ åˆ¸å›¾ + 3 ä¸ªé™æ—¶æŠ˜æ‰£å•†å“ï¼ˆåŸä»· + ç°ä»·ï¼‰
        const COUPON_IMG = 'source/é…é¥°1.jpg';
        const REWARD_PRODUCTS = [
            { name: 'Oversized Suit', originalPrice: 899, price: 719, img: 'source/ä¸Šè¡£1.jpg' },
            { name: 'Striped Shirt', originalPrice: 299, price: 239, img: 'source/ä¸Šè¡£3.jpg' },
            { name: 'Straight Leg Jeans', originalPrice: 399, price: 319, img: 'source/ä¸‹è¡£1.jpg' }
        ];

        const MODELS = [
            { id: 1, img: 'source/æ¨¡ç‰¹1.png' },
            { id: 2, img: 'source/æ¨¡ç‰¹2.png' },
            { id: 3, img: 'source/æ¨¡ç‰¹3.png' },
            { id: 4, img: 'source/æ¨¡ç‰¹4.png' },
            { id: 5, img: 'source/æ¨¡ç‰¹5.png' }
        ];
        const POSES = [
            { id: 1, img: 'source/å§¿åŠ¿1.png' },
            { id: 2, img: 'source/å§¿åŠ¿2.png' },
            { id: 3, img: 'source/å§¿åŠ¿3.png' },
            { id: 4, img: 'source/å§¿åŠ¿4.png' },
            { id: 5, img: 'source/å§¿åŠ¿5.png' }
        ];
        let state = { currentTheme: null, selections: {}, currentCategory: null, model: null, pose: null };
        let resultOotdImage = 'source/ç»„åˆ1.png';

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            const tabBar = document.getElementById('tab-bar');
            tabBar.style.display = (pageId === 'page-editor' || pageId === 'page-result') ? 'none' : 'flex';
            if(pageId === 'page-square') renderSquare();
            if(pageId === 'page-leaderboard') renderLeaderboard();
            if(pageId === 'page-recommend') renderRecommendPage();
        }

        function init() {
            const list = document.getElementById('theme-list');
            THEMES.forEach(t => {
                const card = document.createElement('div');
                card.className = 'card overflow-hidden flex flex-col';
                card.innerHTML = `
                    <img src="${t.img}" class="w-full aspect-[4/5] object-cover">
                    <div class="p-3 flex flex-col flex-1">
                        <div class="font-bold text-sm">${t.title}</div>
                        <button class="mt-2 text-xs font-bold text-white bg-orange-500 rounded-full px-3 py-1">Challenge</button>
                    </div>
                `;
                card.onclick = () => {
                    state.currentTheme = t;
                    state.selections = {};
                    state.model = null;
                    state.pose = null;
                    document.getElementById('current-theme-title').innerText = t.title;
                    renderEditor();
                    navigateTo('page-editor');
                };
                list.appendChild(card);
            });
        }

        const MOCK_UPLOAD_IMG = 'source/ä¸Šä¼ ç…§ç‰‡.png';

        function showUploadedImage() {
            const area = document.getElementById('upload-area');
            const preview = document.getElementById('uploaded-preview');
            const placeholder = document.getElementById('upload-placeholder');
            preview.src = MOCK_UPLOAD_IMG;
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            area.style.borderStyle = 'none';
            state.uploadedImage = true;
            if (state.currentTheme) renderEditor();
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('uploaded-preview');
                    const placeholder = document.getElementById('upload-placeholder');
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    state.uploadedImage = true;
                    renderEditor();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderEditor() {
            const container = document.getElementById('category-list');
            container.innerHTML = '';
            state.currentTheme.categories.forEach(cat => {
                const item = state.selections[cat];
                const card = document.createElement('div');
                card.className = `card p-2 flex flex-col items-center text-center border-2 rounded-xl cursor-pointer ${item ? 'border-red-400' : 'border-transparent'}`;
                card.innerHTML = `
                    <div class="w-full aspect-square bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden mb-2">
                        ${item ? `<img src="${item.img}" class="w-full h-full object-cover">` : '<span class="text-2xl text-gray-300">ï¼‹</span>'}
                    </div>
                    <div class="text-[11px] font-bold text-gray-700">${cat}</div>
                    <div class="text-[9px] text-gray-400 truncate w-full">${item ? item.name : 'Select'}</div>
                `;
                card.onclick = () => openPicker(cat);
                container.appendChild(card);
            });

            const isDone = Object.keys(state.selections).length === state.currentTheme.categories.length;
            const btn = document.getElementById('btn-submit');
            btn.className = `w-full btn-gradient py-4 font-bold shadow-lg ${isDone ? 'opacity-100' : 'opacity-50 pointer-events-none'}`;
            btn.onclick = showResult;
        }

        function openPicker(cat) {
            state.currentCategory = cat;
            document.getElementById('picker-title').innerText = `Choose Your ${cat}`;
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            const allProducts = Object.values(PRODUCTS).flat();
            const purchasedNames = new Set(USER_ORDERS.map(o => o.product.name));
            const historyPurchased = allProducts.filter(p => purchasedNames.has(p.name));
            const inCartOrLikes = allProducts.filter(p => !purchasedNames.has(p.name));
            // å‡åŒ€åˆ†åˆ°ä¸¤ç»„ï¼šè‹¥å·²è´­/æœªè´­æ•°é‡æ‚¬æ®Šï¼Œåˆ™æŒ‰ä¸€åŠä¸€åŠæ‹†åˆ†å±•ç¤º
            const half = Math.ceil(allProducts.length / 2);
            const section1 = historyPurchased.length > 0 && inCartOrLikes.length > 0
                ? historyPurchased
                : allProducts.slice(0, half);
            const section2 = historyPurchased.length > 0 && inCartOrLikes.length > 0
                ? inCartOrLikes
                : allProducts.slice(half);

            function appendSection(title, products) {
                if (products.length === 0) return;
                const titleEl = document.createElement('div');
                titleEl.className = 'col-span-2 py-2 px-3 bg-gray-200 rounded-lg text-xs font-bold text-gray-600 mt-2 first:mt-0';
                titleEl.textContent = title;
                grid.appendChild(titleEl);
                products.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'card p-2 text-center text-[10px]';
                    item.innerHTML = `
                        <img src="${p.img}" class="w-full aspect-square object-cover rounded mb-2">
                        <div class="font-bold truncate">${p.name}</div>
                        <div class="text-red-500 mt-1">Â¥${p.price}</div>
                    `;
                    item.onclick = (e) => {
                        e.stopPropagation();
                        state.selections[cat] = p;
                        closePicker();
                        renderEditor();
                    };
                    grid.appendChild(item);
                });
            }
            appendSection('History purchased', section1);
            appendSection('In cart or likes', section2);
            
            document.getElementById('modal-picker').style.display = 'flex';
        }

        function closePicker() { document.getElementById('modal-picker').style.display = 'none'; }

        function showTryonEntry() {
            document.getElementById('modal-tryon').style.display = 'flex';
        }
        function closeTryonEntry() {
            document.getElementById('modal-tryon').style.display = 'none';
            navigateTo('page-landing');
        }

        function showResult() {
            const score = 80 + Math.floor(Math.random() * 20);
            navigateTo('page-result');
            animateValue("ai-score", 0, score, 1000);
            document.getElementById('ai-comment').innerText = "This outfit achieves perfect color balance. AI detected its uniqueness exceeds 92% of users, perfectly matching this year's minimalist trend.";
            
            // å¥–åŠ±æ¨¡å—ï¼š10% Off æ ‡è¯† + 3 ä¸ªé™æ—¶æŠ˜æ‰£å•†å“ï¼ˆåŸä»· + ç°ä»·ï¼‰
            const rewardEl = document.getElementById('reward-products');
            rewardEl.innerHTML = '';
            REWARD_PRODUCTS.forEach(p => {
                rewardEl.innerHTML += `
                    <div class="flex-1 min-w-0 rounded-lg overflow-hidden bg-white border border-gray-200">
                        <img src="${p.img}" class="w-full aspect-square object-cover">
                        <div class="p-1.5 text-center">
                            <div class="text-red-500 text-xs font-bold">Â¥${p.price}</div>
                            <div class="text-[10px] text-gray-400 line-through">Â¥${p.originalPrice}</div>
                        </div>
                    </div>
                `;
            });
            
            resultOotdImage = 'source/å®Œæ•´ç…§ç‰‡1.jpg';
        }

        function animateValue(id, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                document.getElementById(id).innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function saveOotdToLocal() {
            const img = document.getElementById('ootd-combined-img');
            const url = img.src;
            const filename = url.includes('.png') ? 'my-ootd.png' : 'my-ootd.jpg';
            fetch(url).then(r => r.blob()).then(blob => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                URL.revokeObjectURL(a.href);
            }).catch(() => {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
            });
        }

        function shareToSquare() {
            MOCK_SQUARE.unshift({
                user: 'Me',
                score: document.getElementById('ai-score').innerText,
                likes: 0,
                img: resultOotdImage
            });
            navigateTo('page-square');
        }

        function openSquareDrawer(squareItem) {
            const products = getComboProducts(squareItem.img);
            const listEl = document.getElementById('square-drawer-list');
            listEl.innerHTML = '';
            products.forEach(p => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100';
                row.innerHTML = `
                    <img src="${p.img}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" alt="">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-bold text-gray-800 truncate">${p.name}</div>
                        <div class="text-red-500 text-sm font-bold mt-0.5">Â¥${p.price}</div>
                    </div>
                `;
                const btn = document.createElement('button');
                btn.className = 'btn-gradient py-2 px-4 text-xs font-bold rounded-xl flex-shrink-0';
                btn.textContent = 'Purchase';
                btn.onclick = () => {
                    purchaseProduct(p.name, p.price, p.category);
                    closeSquareDrawer();
                };
                row.appendChild(btn);
                listEl.appendChild(row);
            });
            document.getElementById('modal-square-drawer').style.display = 'flex';
        }

        function closeSquareDrawer() {
            document.getElementById('modal-square-drawer').style.display = 'none';
        }

        function renderSquare() {
            const feed = document.getElementById('square-feed');
            feed.innerHTML = '';
            MOCK_SQUARE.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card overflow-hidden cursor-pointer';
                card.innerHTML = `
                    <div class="relative">
                        <img src="${item.img}" class="w-full aspect-[4/5] object-cover">
                        <div class="absolute bottom-2 left-2 bg-black/40 backdrop-blur-md text-white text-[9px] px-2 py-0.5 rounded-full">AI ${item.score}</div>
                    </div>
                    <div class="p-2 flex justify-between items-center text-[10px]">
                        <span class="font-bold">${item.user}</span>
                        <span onclick="event.stopPropagation(); this.innerText = 'â¤ï¸ ' + (parseInt(this.innerText.split(' ')[1])+1)">â¤ï¸ ${item.likes}</span>
                    </div>
                `;
                card.onclick = () => openSquareDrawer(item);
                feed.appendChild(card);
            });
        }

        function renderLeaderboard() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '';
            [...MOCK_SQUARE].sort((a,b)=>b.likes-a.likes).forEach((item, i) => {
                list.innerHTML += `
                    <div class="card p-3 flex items-center">
                        <span class="w-6 font-black ${i<3?'text-orange-500':'text-gray-300'}">${i+1}</span>
                        <img src="${item.img}" class="w-10 h-10 rounded-full object-cover mx-3">
                        <span class="flex-1 text-xs font-bold">${item.user}</span>
                        <span class="text-[10px] text-gray-400">${item.likes} Likes</span>
                    </div>
                `;
            });
        }

        function goToRecommend() {
            closePicker();
            if (state.currentCategory) {
                navigateTo('page-recommend');
            }
        }

        function renderRecommendPage() {
            if (!state.currentCategory) return;
            
            const title = document.getElementById('recommend-title');
            title.innerText = `${state.currentCategory} Recommendations`;
            
            const grid = document.getElementById('recommend-grid');
            grid.innerHTML = '';
            
            const products = PRODUCTS[state.currentCategory] || PRODUCTS['Outerwear'];
            
            products.forEach(p => {
                const item = document.createElement('div');
                item.className = 'card p-3 text-center';
                item.innerHTML = `
                    <img src="${p.img}" class="w-full aspect-square object-cover rounded-lg mb-3">
                    <div class="text-xs font-bold mb-1 truncate">${p.name}</div>
                    <div class="text-red-500 text-sm font-bold mb-3">Â¥${p.price}</div>
                    <button onclick="purchaseProduct('${p.name}', ${p.price}, '${state.currentCategory}')" class="w-full btn-gradient py-2 text-xs font-bold">
                        Order Now
                    </button>
                `;
                grid.appendChild(item);
            });
        }

        function purchaseProduct(name, price, category) {
            // æ¨¡æ‹Ÿä¸‹å•ï¼šæ·»åŠ åˆ°è®¢å•å†å²
            const newOrder = {
                product: {
                    name: name,
                    price: price,
                    img: PRODUCTS[category].find(p => p.name === name)?.img || '',
                    category: category
                },
                orderDate: new Date()
            };
            USER_ORDERS.unshift(newOrder);
            
            // æ˜¾ç¤ºæç¤º
            alert(`Order Placed Successfully: ${name}\nÂ¥${price}`);
            
            // è¿”å›ç¼–è¾‘å™¨é¡µé¢
            navigateTo('page-editor');
        }

        init();
    </script>
</body>
</html>